---
import Layout        from '@/layouts/Layout.astro';
import RepoCard       from '@/components/maker/RepoCard.astro';
import FeaturedRepo   from '@/components/maker/FeaturedRepo.astro';

import { getRepos } from '@/components/scripts/getRepos';

const repos      = await getRepos();
const latestPost = repos.at(-1);
const remainingPosts  = repos.slice(0, -1).reverse();

export const prerender = true;
---

<Layout>
    <div class="mx-auto w-full xl:w-[60rem] px-4 px-0 xl:pt-20 pt-24 xl:pr-8">
        <div class="flex flex-col xl:gap-12">
            <!-- Artículo Principal -->
            <section class="text-neutral-900 dark:text-neutral-100">
                <h2 class="text-2xl text-2xl font-bold mb-4">Último Trabajando</h2>
                {latestPost && <FeaturedRepo {...latestPost} />}
            </section>

            <!-- Entradas Anteriores -->
            <section class="text-neutral-900 dark:text-neutral-100 xl:pt-0 pt-8">
                <h2 class="text-2xl font-bold mb-6">Entradas Anteriores</h2>
                <div id="posts-grid" class="grid xl:grid-cols-2 grid-cols-1 xl:gap-6 gap-12">
                    {remainingPosts
                        .slice(0, 4)
                        .map(repo => <RepoCard {...repo} />)}
                </div>
                {remainingPosts.length > 4 && (
                    <div class="text-base flex justify-center mt-8 ">
                        <button
                            id="load-more"
                            class="px-6 py-2 text-neutral-800 hover:text-blue-500 transition-colors duration-200"
                            data-current-page="1"
                            data-total-posts={JSON.stringify(remainingPosts)}
                        >
                            Cargar más...
                        </button>
                    </div>
                )}
            </section>
        </div>
    </div>
</Layout>

<script>
    import { createRepoCard } from '@/components/scripts/RepoCardTemplate';

    const loadMoreBtn = document.getElementById('load-more');
    const postsGrid = document.getElementById('posts-grid');
    const POSTS_PER_PAGE = 4;

    const allPosts = JSON.parse(loadMoreBtn?.dataset.totalPosts || '[]');

    function loadMorePosts() {
        const currentPage = parseInt(loadMoreBtn.dataset.currentPage);
        const startIndex = currentPage * POSTS_PER_PAGE;
        const endIndex = startIndex + POSTS_PER_PAGE;

        const newPosts = allPosts.slice(startIndex, endIndex);

        if (newPosts.length > 0) {
            const postsHTML = newPosts.map(createRepoCard).join('');
            postsGrid.insertAdjacentHTML('beforeend', postsHTML);
            loadMoreBtn.dataset.currentPage = (currentPage + 1).toString();

            if (endIndex >= allPosts.length) {
                loadMoreBtn.style.display = 'none';
            }
        }
    }

    loadMoreBtn?.addEventListener('click', loadMorePosts);
</script>
